<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Doctor Persistence Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-button {
            background: #4A90E2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #357ABD;
        }
        .test-button.danger {
            background: #e74c3c;
        }
        .test-button.danger:hover {
            background: #c0392b;
        }
        .test-result {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        
        .doctors-editor {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            background: #fafafa;
        }
        .doctor-editor {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: white;
        }
        .doctor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .doctor-header h3 {
            margin: 0;
            color: #4A90E2;
        }
        .btn-remove {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-remove:hover {
            background: #c0392b;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .form-group input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .image-preview img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <h1>üß™ Test de Doctor Persistence Fix</h1>
    
    <div class="test-container">
        <h2>üìä Estado del Sistema</h2>
        <button class="test-button" onclick="checkSystemStatus()">Verificar Estado del Sistema</button>
        <div id="system-status" class="test-result"></div>
    </div>
    
    <div class="test-container">
        <h2>üë®‚Äç‚öïÔ∏è Gesti√≥n de Doctores</h2>
        <button class="test-button" onclick="addTestDoctor()">Agregar Doctor de Prueba</button>
        <button class="test-button danger" onclick="clearAllDoctors()">Limpiar Todos los Doctores</button>
        <button class="test-button" onclick="loadSavedDoctors()">Cargar Doctores Guardados</button>
        <div id="doctor-status" class="test-result"></div>
    </div>
    
    <div class="test-container">
        <h2>üîÑ Test de Persistencia</h2>
        <button class="test-button" onclick="testPersistence()">Probar Persistencia Completa</button>
        <button class="test-button" onclick="simulatePageReload()">Simular Recarga de P√°gina</button>
        <div id="persistence-status" class="test-result"></div>
    </div>
    
    <div class="test-container">
        <h2>üë®‚Äç‚öïÔ∏è Doctores Actuales</h2>
        <div class="doctors-editor" id="doctors-editor">
            <!-- Los doctores se cargar√°n aqu√≠ din√°micamente -->
        </div>
    </div>

    <script src="doctor-persistence-fix.js"></script>
    <script>
        let testResults = [];
        let currentDoctors = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            testResults.push({ message: logMessage, type });
            console.log(logMessage);
        }
        
        function displayResults(elementId, results) {
            const element = document.getElementById(elementId);
            element.innerHTML = results.map(result => {
                const className = result.type === 'success' ? 'success' : 
                                result.type === 'error' ? 'error' : 
                                result.type === 'warning' ? 'warning' : 'info';
                return `<div class="${className}">${result.message}</div>`;
            }).join('');
        }
        
        async function checkSystemStatus() {
            testResults = [];
            log('üîç Verificando estado del sistema...');
            
            // Verificar localStorage
            const localData = localStorage.getItem('siteData');
            if (localData) {
                try {
                    const parsed = JSON.parse(localData);
                    log(`‚úÖ localStorage: ${parsed.doctors ? parsed.doctors.length : 0} doctores encontrados`, 'success');
                } catch (e) {
                    log(`‚ùå localStorage: Error al parsear - ${e.message}`, 'error');
                }
            } else {
                log('‚ö†Ô∏è localStorage: No hay datos guardados', 'warning');
            }
            
            // Verificar Netlify Functions
            try {
                const response = await fetch('/.netlify/functions/site-data');
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Netlify Functions: ${data.doctors ? data.doctors.length : 0} doctores encontrados`, 'success');
                } else {
                    log(`‚ö†Ô∏è Netlify Functions: Error ${response.status}`, 'warning');
                }
            } catch (error) {
                log(`‚ö†Ô∏è Netlify Functions: No disponibles - ${error.message}`, 'warning');
            }
            
            // Verificar entorno
            if (window.location.hostname.includes('netlify.app')) {
                log('‚úÖ Entorno: Netlify detectado', 'success');
            } else {
                log('‚ö†Ô∏è Entorno: Hosting local/otro', 'warning');
            }
            
            displayResults('system-status', testResults);
        }
        
        async function addTestDoctor() {
            testResults = [];
            log('‚ûï Agregando doctor de prueba...');
            
            try {
                // Cargar datos actuales
                const currentData = await loadSiteDataFixed();
                
                // Agregar doctor de prueba
                const testDoctor = {
                    name: `Dr. Test ${Date.now()}`,
                    specialty: "Especialidad de Prueba",
                    experience: Math.floor(Math.random() * 20) + 1,
                    image: "https://images.unsplash.com/photo-1559839734-2b71ea197ec2?w=200&h=250&fit=crop&crop=face&auto=format&q=80"
                };
                
                currentData.doctors = currentData.doctors || [];
                currentData.doctors.push(testDoctor);
                
                // Guardar datos
                const saveSuccess = await saveSiteDataFixed(currentData);
                
                if (saveSuccess) {
                    log(`‚úÖ Doctor agregado: ${testDoctor.name}`, 'success');
                    log(`üìä Total de doctores: ${currentData.doctors.length}`, 'info');
                    
                    // Recargar la vista
                    await loadSavedDoctors();
                } else {
                    log('‚ùå Error al guardar doctor', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Error al agregar doctor: ${error.message}`, 'error');
            }
            
            displayResults('doctor-status', testResults);
        }
        
        async function clearAllDoctors() {
            testResults = [];
            log('üóëÔ∏è Limpiando todos los doctores...');
            
            if (confirm('¬øEst√°s seguro de que quieres eliminar TODOS los doctores?')) {
                try {
                    const currentData = await loadSiteDataFixed();
                    currentData.doctors = [];
                    
                    const saveSuccess = await saveSiteDataFixed(currentData);
                    
                    if (saveSuccess) {
                        log('‚úÖ Todos los doctores eliminados', 'success');
                        await loadSavedDoctors();
                    } else {
                        log('‚ùå Error al guardar cambios', 'error');
                    }
                } catch (error) {
                    log(`‚ùå Error al limpiar doctores: ${error.message}`, 'error');
                }
            } else {
                log('‚ùå Operaci√≥n cancelada por el usuario', 'warning');
            }
            
            displayResults('doctor-status', testResults);
        }
        
        async function loadSavedDoctors() {
            testResults = [];
            log('üì• Cargando doctores guardados...');
            
            try {
                const savedData = await loadSiteDataFixed();
                currentDoctors = savedData.doctors || [];
                
                log(`‚úÖ ${currentDoctors.length} doctores cargados`, 'success');
                
                // Actualizar la vista
                populateFormsFixed(savedData);
                
            } catch (error) {
                log(`‚ùå Error al cargar doctores: ${error.message}`, 'error');
            }
            
            displayResults('doctor-status', testResults);
        }
        
        async function testPersistence() {
            testResults = [];
            log('üîÑ Iniciando test de persistencia...');
            
            try {
                // Paso 1: Agregar doctor de prueba
                log('üìù Paso 1: Agregando doctor de prueba...');
                const testDoctor = {
                    name: `Dr. Persistencia Test ${Date.now()}`,
                    specialty: "Test de Persistencia",
                    experience: 10,
                    image: "https://images.unsplash.com/photo-1559839734-2b71ea197ec2?w=200&h=250&fit=crop&crop=face&auto=format&q=80"
                };
                
                const currentData = await loadSiteDataFixed();
                currentData.doctors = currentData.doctors || [];
                currentData.doctors.push(testDoctor);
                
                const saveSuccess = await saveSiteDataFixed(currentData);
                if (!saveSuccess) {
                    throw new Error('Error al guardar doctor de prueba');
                }
                
                log(`‚úÖ Doctor agregado: ${testDoctor.name}`, 'success');
                
                // Paso 2: Esperar y verificar
                log('‚è≥ Paso 2: Esperando 2 segundos...');
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Paso 3: Cargar datos y verificar
                log('üîç Paso 3: Verificando persistencia...');
                const verifyData = await loadSiteDataFixed();
                const foundDoctor = verifyData.doctors.find(d => d.name === testDoctor.name);
                
                if (foundDoctor) {
                    log('‚úÖ Persistencia verificada: Doctor encontrado', 'success');
                    
                    // Paso 4: Eliminar doctor de prueba
                    log('üóëÔ∏è Paso 4: Eliminando doctor de prueba...');
                    verifyData.doctors = verifyData.doctors.filter(d => d.name !== testDoctor.name);
                    
                    const deleteSuccess = await saveSiteDataFixed(verifyData);
                    if (deleteSuccess) {
                        log('‚úÖ Doctor eliminado exitosamente', 'success');
                        log('üéâ TEST DE PERSISTENCIA COMPLETADO', 'success');
                    } else {
                        log('‚ùå Error al eliminar doctor de prueba', 'error');
                    }
                } else {
                    log('‚ùå Persistencia fallida: Doctor no encontrado', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Error en test de persistencia: ${error.message}`, 'error');
            }
            
            displayResults('persistence-status', testResults);
        }
        
        async function simulatePageReload() {
            testResults = [];
            log('üîÑ Simulando recarga de p√°gina...');
            
            try {
                // Cargar datos guardados
                const savedData = await loadSiteDataFixed();
                log(`üìä Doctores encontrados: ${savedData.doctors ? savedData.doctors.length : 0}`, 'info');
                
                // Reconstruir la vista
                populateFormsFixed(savedData);
                
                log('‚úÖ P√°gina reconstruida con datos guardados', 'success');
                
            } catch (error) {
                log(`‚ùå Error al simular recarga: ${error.message}`, 'error');
            }
            
            displayResults('persistence-status', testResults);
        }
        
        // Funci√≥n para eliminar doctor (compatible con el HTML generado)
        async function removeDoctorFixed(doctorId) {
            console.log('üóëÔ∏è Eliminando doctor:', doctorId);
            
            if (confirm('¬øEst√°s seguro de que quieres eliminar este doctor?')) {
                try {
                    // Cargar datos actuales
                    const currentData = await loadSiteDataFixed();
                    
                    // Eliminar doctor por √≠ndice
                    if (currentData.doctors && currentData.doctors.length > 0) {
                        currentData.doctors.splice(doctorId - 1, 1);
                        
                        // Guardar datos actualizados
                        const saveSuccess = await saveSiteDataFixed(currentData);
                        
                        if (saveSuccess) {
                            alert('Doctor eliminado exitosamente');
                            await loadSavedDoctors(); // Recargar vista
                        } else {
                            alert('Error al guardar cambios');
                        }
                    }
                } catch (error) {
                    console.error('Error al eliminar doctor:', error);
                    alert('Error al eliminar doctor');
                }
            }
        }
        
        // Funci√≥n para preview de imagen (placeholder)
        function previewImage(input, previewId) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById(previewId);
                    if (preview) {
                        preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                    }
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Inicializar cuando la p√°gina cargue
        window.addEventListener('load', async function() {
            await checkSystemStatus();
            await loadSavedDoctors();
        });
    </script>
</body>
</html>


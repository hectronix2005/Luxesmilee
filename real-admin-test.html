<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Real del Admin - Simulaci√≥n Exacta</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .admin-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .doctors-editor {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            background: #fafafa;
        }
        .doctor-editor {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: white;
        }
        .doctor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .doctor-header h3 {
            margin: 0;
            color: #4A90E2;
        }
        .btn-remove {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-remove:hover {
            background: #c0392b;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .form-group input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .test-button {
            background: #4A90E2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #357ABD;
        }
        .test-button.danger {
            background: #e74c3c;
        }
        .test-button.danger:hover {
            background: #c0392b;
        }
        .test-result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            border-left: 4px solid #4A90E2;
        }
        .success { background: #d4edda; color: #155724; border-left-color: #28a745; }
        .error { background: #f8d7da; color: #721c24; border-left-color: #dc3545; }
        .warning { background: #fff3cd; color: #856404; border-left-color: #ffc107; }
        .info { background: #d1ecf1; color: #0c5460; border-left-color: #17a2b8; }
    </style>
</head>
<body>
    <h1>üîç Test Real del Admin - Simulaci√≥n Exacta del Comportamiento</h1>
    
    <div class="admin-container">
        <h2>üéÆ Controles de Test</h2>
        <button class="test-button" onclick="simulateLogin()">üîê Simular Login</button>
        <button class="test-button" onclick="simulateLogout()">üö™ Simular Logout</button>
        <button class="test-button" onclick="addTestDoctor()">‚ûï Agregar Doctor</button>
        <button class="test-button danger" onclick="clearAllData()">üóëÔ∏è Limpiar Datos</button>
        <button class="test-button" onclick="runPersistenceTest()">üß™ Test de Persistencia</button>
        <div id="test-results" class="test-result"></div>
    </div>
    
    <div class="admin-container">
        <h2>üë®‚Äç‚öïÔ∏è Doctores (Simulaci√≥n del Admin Real)</h2>
        <div class="doctors-editor" id="doctors-editor">
            <!-- Los doctores se cargar√°n aqu√≠ -->
        </div>
    </div>

    <script>
        // Simulaci√≥n exacta del comportamiento del admin real
        let siteData = {};
        let hasUnsavedChanges = false;
        let doctorCounter = 2; // Start from 3 since we have 2 default doctors
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            console.log(logMessage);
            
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.textContent = logMessage;
            resultsDiv.appendChild(resultDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        // Simular login
        function simulateLogin() {
            log('üîê Simulando login...');
            localStorage.setItem('adminLoggedIn', 'true');
            loadSiteData();
            log('‚úÖ Login simulado - cargando datos', 'success');
        }
        
        // Simular logout
        function simulateLogout() {
            log('üö™ Simulando logout...');
            localStorage.removeItem('adminLoggedIn');
            // NO limpiar siteData - esto es clave
            log('‚úÖ Logout simulado - datos preservados', 'success');
        }
        
        // Cargar datos (simulaci√≥n exacta del admin real)
        async function loadSiteData() {
            log('üì• Cargando datos del sitio...');
            
            try {
                // Try to load from Netlify Function first (primary source)
                try {
                    const response = await fetch('/.netlify/functions/site-data');
                    if (response.ok) {
                        siteData = await response.json();
                        log('‚úÖ Datos cargados desde Netlify Function', 'success');
                        populateForms();
                        return;
                    } else {
                        log('‚ö†Ô∏è Netlify Function error: ' + response.status, 'warning');
                    }
                } catch (apiError) {
                    log('‚ö†Ô∏è Netlify Function no disponible: ' + apiError.message, 'warning');
                }
                
                // Try localStorage (fallback source)
                const savedData = localStorage.getItem('siteData');
                if (savedData) {
                    try {
                        siteData = JSON.parse(savedData);
                        log('‚úÖ Datos cargados desde localStorage', 'success');
                        populateForms();
                        return;
                    } catch (parseError) {
                        log('‚ùå Error al parsear localStorage: ' + parseError.message, 'error');
                    }
                }
                
                // If no data found, load defaults
                log('‚ÑπÔ∏è No hay datos guardados, cargando por defecto', 'info');
                loadDefaultData();
                
            } catch (error) {
                log('‚ùå Error al cargar datos: ' + error.message, 'error');
                loadDefaultData();
            }
        }
        
        // Cargar datos por defecto (simulaci√≥n exacta)
        function loadDefaultData() {
            log('üìã Cargando datos por defecto...');
            siteData = {
                hero: {
                    title: "Renueva Tu Confianza con Nuestro Dise√±o de Sonrisa",
                    subtitle: "Alcanza la sonrisa que siempre has deseado",
                    features: [
                        "Transformaci√≥n est√©tica personalizada para tu sonrisa ideal.",
                        "Correcci√≥n de imperfecciones dentales con carillas y blanqueamiento.",
                        "Tecnolog√≠a avanzada para resultados precisos y naturales."
                    ]
                },
                doctors: [
                    {
                        name: "Dra. Paola Pe√±a",
                        specialty: "Odont√≥loga - Universidad Javeriana | Esp. en Implantolog√≠a oral y reconstructiva",
                        experience: 15,
                        image: "https://images.unsplash.com/photo-1559839734-2b71ea197ec2?w=400&h=500&fit=crop&crop=face"
                    },
                    {
                        name: "Dra. Patricia Herrera",
                        specialty: "Odont√≥loga - Universidad Javeriana | Esp. en Ortodoncia, maloclusiones y alineaci√≥n dental",
                        experience: 12,
                        image: "https://images.unsplash.com/photo-1594824388852-8a7b3b5b5b5b?w=400&h=500&fit=crop&crop=face"
                    }
                ],
                services: [],
                gallery: [],
                testimonials: [],
                contact: {},
                settings: {}
            };
            
            populateForms();
        }
        
        // Poblar formularios (simulaci√≥n exacta del admin real)
        function populateForms() {
            log('üìù Poblando formularios...');
            
            // Doctors - Dynamic loading
            if (siteData.doctors) {
                const doctorsEditor = document.querySelector('.doctors-editor');
                
                // Clear ALL existing doctors to rebuild from saved data
                const existingDoctors = doctorsEditor.querySelectorAll('.doctor-editor[data-doctor-id]');
                existingDoctors.forEach((doctor) => {
                    doctor.remove();
                });
                
                // Reset doctor counter
                doctorCounter = 0;
                
                // Load doctors dynamically from saved data
                siteData.doctors.forEach((doctor, index) => {
                    doctorCounter++;
                    
                    // Create doctor HTML
                    const doctorHTML = `
                        <div class="doctor-editor" data-doctor-id="${doctorCounter}">
                            <div class="doctor-header">
                                <h3>${doctor.name || 'Doctor'}</h3>
                                <button class="btn-remove" onclick="removeDoctor(${doctorCounter})" title="Eliminar doctor">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="doctor${doctorCounter}-name">Nombre</label>
                                    <input type="text" id="doctor${doctorCounter}-name" value="${doctor.name || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="doctor${doctorCounter}-specialty">Especialidad</label>
                                    <input type="text" id="doctor${doctorCounter}-specialty" value="${doctor.specialty || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="doctor${doctorCounter}-experience">A√±os de Experiencia</label>
                                    <input type="number" id="doctor${doctorCounter}-experience" value="${doctor.experience || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="doctor${doctorCounter}-image">Foto</label>
                                    <div class="image-upload">
                                        <input type="file" id="doctor${doctorCounter}-image" accept="image/*">
                                        <div class="upload-area">
                                            <span>Subir foto</span>
                                        </div>
                                        <div class="image-preview" id="doctor${doctorCounter}-preview">
                                            <img src="${doctor.image || 'https://images.unsplash.com/photo-1559839734-2b71ea197ec2?w=200&h=250&fit=crop&crop=face&auto=format&q=80'}" alt="${doctor.name || 'Doctor'}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    doctorsEditor.insertAdjacentHTML('beforeend', doctorHTML);
                });
                
                log(`‚úÖ ${siteData.doctors.length} doctores cargados`, 'success');
            }
        }
        
        // Recolectar datos de formularios (simulaci√≥n exacta)
        function collectFormData() {
            log('üìä Recolectando datos de formularios...');
            
            // Doctors - Dynamic collection
            const doctorEditors = document.querySelectorAll('.doctor-editor');
            const newDoctors = [];
            
            doctorEditors.forEach((editor, index) => {
                const doctorId = editor.getAttribute('data-doctor-id');
                
                const nameElement = document.getElementById(`doctor${doctorId}-name`);
                const specialtyElement = document.getElementById(`doctor${doctorId}-specialty`);
                const experienceElement = document.getElementById(`doctor${doctorId}-experience`);
                
                if (nameElement && specialtyElement && experienceElement) {
                    // Preserve existing image data
                    const existingDoctor = siteData.doctors && siteData.doctors[index] ? siteData.doctors[index] : null;
                    const imageData = existingDoctor?.image || '';
                    
                    const doctorData = {
                        name: nameElement.value,
                        specialty: specialtyElement.value,
                        experience: parseInt(experienceElement.value) || 0,
                        image: imageData
                    };
                    
                    newDoctors.push(doctorData);
                }
            });
            
            siteData.doctors = newDoctors;
            log(`üìä ${newDoctors.length} doctores recolectados`, 'info');
        }
        
        // Guardar cambios (simulaci√≥n exacta)
        async function saveAllChanges() {
            log('üíæ Guardando cambios...');
            
            try {
                // Collect all form data
                collectFormData();
                
                // Try to save to Netlify Function first (primary storage)
                try {
                    const response = await fetch('/.netlify/functions/site-data', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(siteData)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        log('‚úÖ Datos guardados en Netlify Function', 'success');
                        
                        // Save to localStorage as backup
                        localStorage.setItem('siteData', JSON.stringify(siteData));
                        log('üíæ Backup guardado en localStorage', 'info');
                        return;
                    } else {
                        log('‚ùå Error en Netlify Function: ' + response.status, 'error');
                    }
                } catch (apiError) {
                    log('‚ö†Ô∏è Netlify Function no disponible: ' + apiError.message, 'warning');
                }
                
                // Fallback to localStorage
                localStorage.setItem('siteData', JSON.stringify(siteData));
                log('‚úÖ Datos guardados en localStorage', 'success');
                
            } catch (error) {
                log('‚ùå Error al guardar: ' + error.message, 'error');
            }
        }
        
        // Eliminar doctor (simulaci√≥n exacta del admin real)
        async function removeDoctor(doctorId) {
            log(`üóëÔ∏è Eliminando doctor ID: ${doctorId}`);
            
            if (confirm('¬øEst√°s seguro de que quieres eliminar este doctor? Esta acci√≥n no se puede deshacer.')) {
                const doctorElement = document.querySelector(`[data-doctor-id="${doctorId}"]`);
                
                if (doctorElement) {
                    // Remove from DOM
                    doctorElement.remove();
                    log('‚úÖ Doctor eliminado del DOM', 'success');
                    
                    // Immediately save changes to persist the deletion
                    collectFormData();
                    log('üìä Datos recolectados despu√©s de eliminaci√≥n', 'info');
                    
                    // Save to Netlify Function FIRST (primary storage)
                    try {
                        const response = await fetch('/.netlify/functions/site-data', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(siteData)
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            log('‚úÖ Eliminaci√≥n guardada en Netlify Function', 'success');
                            
                            // Save to localStorage as backup
                            localStorage.setItem('siteData', JSON.stringify(siteData));
                            log('üíæ Backup guardado en localStorage', 'info');
                            
                            hasUnsavedChanges = false;
                            log('üéâ Doctor eliminado y cambios guardados permanentemente', 'success');
                        } else {
                            log('‚ùå Error en Netlify Function: ' + response.status, 'error');
                            
                            // Fallback to localStorage
                            localStorage.setItem('siteData', JSON.stringify(siteData));
                            log('üíæ Guardado en localStorage como fallback', 'warning');
                        }
                    } catch (apiError) {
                        log('‚ö†Ô∏è Netlify Function no disponible: ' + apiError.message, 'warning');
                        
                        // Fallback to localStorage
                        localStorage.setItem('siteData', JSON.stringify(siteData));
                        log('üíæ Guardado en localStorage como fallback', 'warning');
                    }
                } else {
                    log('‚ùå No se encontr√≥ el elemento del doctor', 'error');
                }
            } else {
                log('‚ùå Eliminaci√≥n cancelada por el usuario', 'warning');
            }
        }
        
        // Agregar doctor de prueba
        function addTestDoctor() {
            log('‚ûï Agregando doctor de prueba...');
            
            const testDoctor = {
                name: `Dr. Test ${Date.now()}`,
                specialty: "Especialidad de Prueba",
                experience: 10,
                image: "https://images.unsplash.com/photo-1559839734-2b71ea197ec2?w=200&h=250&fit=crop&crop=face&auto=format&q=80"
            };
            
            siteData.doctors = siteData.doctors || [];
            siteData.doctors.push(testDoctor);
            
            // Guardar y recargar
            saveAllChanges().then(() => {
                populateForms();
                log(`‚úÖ Doctor agregado: ${testDoctor.name}`, 'success');
            });
        }
        
        // Limpiar todos los datos
        function clearAllData() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar TODOS los datos?')) {
                log('üóëÔ∏è Limpiando todos los datos...');
                localStorage.removeItem('siteData');
                localStorage.removeItem('adminLoggedIn');
                siteData = {};
                document.querySelector('.doctors-editor').innerHTML = '';
                log('‚úÖ Todos los datos limpiados', 'success');
            }
        }
        
        // Test de persistencia completo
        async function runPersistenceTest() {
            log('üß™ Iniciando test de persistencia...');
            
            try {
                // Paso 1: Agregar doctor
                log('üìù Paso 1: Agregando doctor de prueba...');
                const testDoctor = {
                    name: `Dr. Persistencia Test ${Date.now()}`,
                    specialty: "Test de Persistencia",
                    experience: 15,
                    image: "https://images.unsplash.com/photo-1559839734-2b71ea197ec2?w=200&h=250&fit=crop&crop=face&auto=format&q=80"
                };
                
                siteData.doctors = siteData.doctors || [];
                siteData.doctors.push(testDoctor);
                await saveAllChanges();
                populateForms();
                log(`‚úÖ Doctor agregado: ${testDoctor.name}`, 'success');
                
                // Paso 2: Simular logout/login
                log('üìù Paso 2: Simulando logout/login...');
                localStorage.removeItem('adminLoggedIn');
                await new Promise(resolve => setTimeout(resolve, 1000));
                localStorage.setItem('adminLoggedIn', 'true');
                await loadSiteData();
                log('‚úÖ Logout/login simulado', 'success');
                
                // Paso 3: Verificar que el doctor persiste
                log('üìù Paso 3: Verificando persistencia...');
                const foundDoctor = siteData.doctors.find(d => d.name === testDoctor.name);
                if (foundDoctor) {
                    log('‚úÖ Doctor encontrado despu√©s de logout/login', 'success');
                    
                    // Paso 4: Eliminar el doctor
                    log('üìù Paso 4: Eliminando doctor...');
                    const doctorElement = document.querySelector(`[data-doctor-id]`);
                    if (doctorElement) {
                        const doctorId = doctorElement.getAttribute('data-doctor-id');
                        await removeDoctor(doctorId);
                        
                        // Paso 5: Simular logout/login nuevamente
                        log('üìù Paso 5: Simulando logout/login despu√©s de eliminaci√≥n...');
                        localStorage.removeItem('adminLoggedIn');
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        localStorage.setItem('adminLoggedIn', 'true');
                        await loadSiteData();
                        
                        // Paso 6: Verificar que la eliminaci√≥n persiste
                        log('üìù Paso 6: Verificando que la eliminaci√≥n persiste...');
                        const doctorStillExists = siteData.doctors.find(d => d.name === testDoctor.name);
                        if (!doctorStillExists) {
                            log('üéâ TEST COMPLETADO: Persistencia funcionando correctamente', 'success');
                        } else {
                            log('‚ùå TEST FALLIDO: Doctor a√∫n existe despu√©s de eliminaci√≥n', 'error');
                        }
                    } else {
                        log('‚ùå No se encontr√≥ doctor para eliminar', 'error');
                    }
                } else {
                    log('‚ùå Doctor no encontrado despu√©s de logout/login', 'error');
                }
                
            } catch (error) {
                log('‚ùå Error en test de persistencia: ' + error.message, 'error');
            }
        }
        
        // Inicializar cuando la p√°gina cargue
        window.addEventListener('load', function() {
            log('üöÄ Test del admin real inicializado', 'info');
            loadSiteData();
        });
    </script>
</body>
</html>

